<!DOCTYPE html>
<html>
<head>


<link href="bower_components/polymer/polymer.html" rel="import">
<link href="bower_components/wallcology-selector/styles/app-theme.html" rel="import">
<link href="bower_components/paper-styles/paper-styles.html" rel="import">

<link href="bower_components/paper-button/paper-button.html" rel="import">
<link href="bower_components/paper-icon-button/paper-icon-button.html" rel="import">

<link href="bower_components/iron-ajax/iron-ajax.html" rel="import">
<link href="bower_components/iron-flex-layout/iron-flex-layout.html" rel="import">


<link href="bower_components/iron-icons/iron-icons.html" rel="import">
<link href="bower_components/iron-icon/iron-icon.html" rel="import">
<link href="bower_components/iron-icons/communication-icons.html" rel="import">
<link href="bower_components/iron-iconset-svg/iron-iconset-svg.html" rel="import">
<link href="bower_components/iron-iconset/iron-iconset.html" rel="import">

<script type="text/javascript" src="bower_components/predicates.js/browser/predicates.js"></script>


</head>

<dom-module id="action-selector">
<style>

    :host {

    }

    .pink {
        background-color: var(--paper-pink-500);
    }

    .yellow {
        background-color: var(--paper-yellow-500);
    }

    .bug {
        --iron-icon-height: 150px;
        --iron-icon-width: 150px;
    }

    paper-button.colorful {
        color: white;
        background: var(--paper-blue-500);
    }

    .vcontainer {
    @apply(--layout-horizontal);
                @apply(--layout-center);
    }

    paper-icon-button[toggles].selector {
        margin: 20px;
        padding: 0px;
    }

    paper-icon-button[toggles] {
        transition: background-color 0.3s;

    }

    paper-icon-button[toggles][active] {
        background-color: rgba(255, 233, 33, 0.25);
        border-radius: 25px;
    }
    paper-icon-button[toggles][disabled] {
        opacity: 0.25;
        border-radius: 25px;
    }

    .spacer {
        margin: 5px;
    }

</style>
<template id="layout">

    <div class="horizontal layout">
        <div id="key" class="spacer">
            <template id="buttonTemplate" is="dom-repeat" items="{{buttonSelectors}}">
                <paper-icon-button toggles disabled id="{{index}}"  on-tap="buttonTapped"  src="{{item.imgUrl}}" class="bug selector"></paper-icon-button>
            </template>
        </div>

    </div>

</template>

<script>
    // element registration
Polymer({
    is: 'action-selector',

    // add properties and methods on the element's prototype
    properties: {
        // declare properties for the element's public API
        selectedItems: {
            type: Array,
            notify: true,
        },
        maxSelections: {
            type: Number,
            notify: true,
            value: 0
        },
        currentToggle: {
            type: Object,
            notify: true,
            value: {}
        },
        toggleSelectors: {
            type: Array,
            notify: true,
            value: []
        },
        buttonSelectors: {
            type: Array,
            notify: true,
            value: []
        }
    },
    observers: [
        'currentToggleChange(currentToggle.*)',
        'selectedItemsChanged(selectedItems.*)',
        'toggleSelectorsChanged(toggleSelectors.*)',
        'buttonSelectorsChanged(buttonSelectors.*)'
    ],
    currentToggleChange: function(currentToggle) {
        if(this.toggleSelectors == undefined) {
            return;
        }

        var buttons = Polymer.dom(this.$.key).querySelectorAll('paper-icon-button');
        for( var i = 0; i < buttons.length; i++) {
            var b = buttons[i];

            if(currentToggle.value.index < 0) {
                b.disabled = true;
            }
            else {
                b.disabled = false;
            }

        }

    },
    selectedItemsChanged: function (changeRecord) {
        if (changeRecord.value !== null && this.selectedItems[0] !== null) {
        }
    },
    buttonSelectorsChanged: function (changeRecord) {
        if (changeRecord.path == 'buttonSelectors.splices') {
            // a user was added or removed
        } else {
            // an individual user or its sub-properties changed
            // check "changeRecord.path" to determine what changed
        }
    },
    toggleSelectorsChanged: function(changeRecord){
        console.log('toggle', changeRecord);
        if( this.currentToggle.name === undefined && this.toggleSelectors[0] !== undefined  ) {
            for( var i =  0; i < this.toggleSelectors.length; i++) {
                if( this.toggleSelectors[i].index === -1 ) {
                    this.currentToggle = this.toggleSelectors[i];
                    this.disableButtons(undefined);
                }
            }
        }
    },
    toggleTapped: function (e) {
        console.log('toggle tapped');
        if( this.currentToggle !== undefined ) {
            var previousIndex = this.currentToggle.index;
            var newIndex = previousIndex + 1;

            var nextToggle = this.findToggle(newIndex);

            if( nextToggle !== undefined ) {
                this.currentToggle = nextToggle;
                this.disableButtons(nextToggle.items);


            } else {
                this.currentToggle = this.findToggle(-1);
                this.disableButtons(undefined);
            }
        }
    },
    disableButtons: function(buttonIndexes) {
        if( buttonIndexes === undefined ) {
            //disable all array
            var buttons = Polymer.dom(this.$.key).querySelectorAll('paper-icon-button');
            for( var i = 0; i < buttons.length; i++) {
                var b = buttons[i];


                b.disabled = true;


            }
        } else {
            console.log('indexs to disable', buttonIndexes);
            var buttons = Polymer.dom(this.$.key).querySelectorAll('paper-icon-button');
            for( var i = 0; i < buttons.length; i++) {
                var b = buttons[i];
                var doesContain = predicates.in(buttonIndexes);
                var bIndex = parseInt(b.id);
                var truth = doesContain(bIndex);
                if( truth ) {
                    b.disabled = false;
                } else {
                    b.disabled = true;
                }

            }
        }
    },
    buttonTapped: function (e) {

        if( !this.hasMaxSelections() ) {
            var selectedItem = e.model.item;

            if (e.currentTarget.active) {
                this.push('selectedItems', selectedItem);
            } else {

                this.splice('selectedItems', selectedItem, 1);

            }
        } else {
            console.log('TOO MANY SELECTIONS');
            e.currentTarget.active = false;
        }
    },
    selectAction: function (index) {
        if(this.children[0].children[0].children[index].active || this.children[0].children[0].children[index].disabled) {
            console.log('Already active or disabled');
            return;
        }

        if( !this._hasMaxSelections() ) {
            this.children[0].children[0].children[index].active = true;
            var selectedItem = this.buttonSelectors[index];
            this.push('selectedItems', selectedItem);
        }
    },
    deselectAction: function (index) {
        if(this.children[0].children[0].children[index].active) {
            this.children[0].children[0].children[index].active = false;
            var selectedItem = this.buttonSelectors[index];
            //this.push('selectedItems', selectedItem);
            this.splice('selectedItems', selectedItem, 1);
        }
    },
    hasMaxSelections: function() {

        var buttons = Polymer.dom(this.$.key).querySelectorAll('paper-icon-button');
        var active = 0;
        for( var i = 0; i < buttons.length; i++) {
            var b = buttons[i];
            if(b.active) {
                active++;
            }
        }

        if( active > this.maxSelections ) {
            console.log('max selections' + this.maxSelections);
            return true;
        }
        return false;
    },
    _hasMaxSelections: function() {

        var buttons = Polymer.dom(this.$.key).querySelectorAll('paper-icon-button');
        var active = 0;
        for( var i = 0; i < buttons.length; i++) {
            var b = buttons[i];
            if(b.active) {
                active++;
            }
        }

        if( active >= this.maxSelections ) {
            console.log('max selections' + this.maxSelections);
            return true;
        }
        return false;
    },
    findToggle: function(index) {
        for(var i = 0; i < this.toggleSelectors.length; i++) {
            if( index === this.toggleSelectors[i].index ) {
                return this.toggleSelectors[i];
            }
        }
        return undefined;
    },

    toUpperCase: function (someString) {
        if (someString !== null) {
            return someString.toUpperCase();
        }
        return null;
    },
    ready: function () {
        this.selectedItems = [];
        this.buttonSelectors = [];
        this.toggleSelectors = [];
    }
});
</script>
</dom-module>
