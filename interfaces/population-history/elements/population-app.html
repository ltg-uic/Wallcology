<!--<link rel="import" href="./shared-styles/shared-styles.html">-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment.min.js"></script>
<dom-module id="population-app">
  <template>
    <style include="shared-styles"></style>
    <style>
      :host {
      }

      google-chart {
        height: 150px;
        width: 100%;
        background-color: #ffffff;
        padding: 0px;
        margin: 0px;
      }

      iron-icon {
        width: 60px;
        height: 60px;
        margin-left: 5px;
      }

      .dateSpacer {
        height: 80px;
        width: 80px;
        padding: 0px;
        margin: 0px;
      }

      .leftspacer {
        margin-left: 70px;
      }

      .rightspacer {
        margin-right: 30px;
      }

      .rightpadder {
        margin-right: 0px;
      }

      .nopadding {
        padding: 0px;
        margin: 0px;
      }

      .startdateSpacer {
        padding: 0px;
        margin: 200px;
        width: 0px;
      }

      paper-toolbar ::shadow #topBar {
        padding: 0 4px;
        background-color: white;
      }

      .graph-icon {
        padding: 0 4px;
      }

      .button-title {
        color: #000;
        text-align: center;
        font-size: 11px;
      }

      paper-button.colorful {
        color: white;
        background: #237599;
        margin-top: 3px;
        font-size: 12px;
      }

    </style>


    <nutella-connector connected={{connected}} id="nutellaConn" hostname="ltg.evl.uic.edu" appid="wallcology"
                       runid="default"
                       componentid="wallcology_admin" roomcast></nutella-connector>
    <paper-toolbar>

      <div class="start">
        <div class="vertical-section-container">
          <div class="vertical-section">
            <paper-button id="startDateButton" on-tap="showStartDateDialogAction" class="colorful"><span>{{formatButtonSDate(startDate)}}</span>
            </paper-button>
          </div>
          <div class="vertical-section center">
            <div class="button-title">START</div>
          </div>
        </div>
      </div>
      </div>
      <div class="center flex">
        <div class="horizontal-section-container">

          <div class="horizontal-section">
            <wallcology-selector id="ws" toggle-selectors="{{toggleSelectors}}" button-selectors="{{buttonSelectors}}"
                                 max-selections="4" selected-items="{{selectedItems}}"
                                 current-toggle="{{currentToggle}}"></wallcology-selector>
          </div>
        </div>
      </div>
      <div class="end">
        <div class="vertical-section-container">
          <div class="vertical-section">
            <paper-button id="endDateButton" class="colorful" on-tap="showEndDateDialogAction"><span>{{formatButtonEDate(endDate)}}</span>
            </paper-button>
          </div>
          <div class="vertical-section center">
            <div class="button-title">END</div>
          </div>
        </div>
      </div>
    </paper-toolbar>

    <div class="vertical-section-container">
      <template is="dom-repeat" items="{{graphs}}">
        <section>
          <div class="vertical-section center">

            <div class="horizontal layout center graph-icon">
              <iron-icon src="{{item.highlightUrl}}" style="width: 60px;"></iron-icon>

              <div class="center flex rightpadder">
                <google-chart auto-fit-on-attach id="{{chartName(item.index)}}"
                              type='column'
                              options='{{item.options}}'
                              data={{item.data}}>
                </google-chart>

              </div>
            </div>

          </div>
        </section>
      </template>
    </div>

    <!-- YYYY-MM-DD -->
    <paper-dialog id="startDateDialog" class="paper-date-picker-dialog" modal
                  on-iron-overlay-closed="dismissDialog">
      <paper-date-picker id="startDatePicker" date="{{startDate}}" min-date="{{endDate}}"></paper-date-picker>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm>OK</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="endDateDialog" class="paper-date-picker-dialog" modal
                  on-iron-overlay-closed="dismissDialog">
      <paper-date-picker id="endDatePicker" date="{{endDate}}" min-date="2015-10-12"></paper-date-picker>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm>OK</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="modal" modal>
      <p>{{alertMessage}}</p>

      <div class="buttons">
        <paper-button dialog-confirm autofocus>OK</paper-button>
      </div>
    </paper-dialog>


  </template>

  <script>
    // element registration
    Polymer({
      is: 'population-app',

      // add properties and methods on the element's prototype
      properties: {
        // declare properties for the element's public API
        selectedItems: {
          type: Array,
          notify: true,
          value: []
        },
        currentToggle: {
          type: Object,
          notify: true,
          value: function () {
            return {};
          },
          observer: 'currentToggleChanged'
        },
        toggleSelectors: {
          type: Array,
          notify: true,
          value: [
            {
              'items': [
                0,
                1,
                2,
                3,
                4,
                5,
                6,
                7,
                8,
                9,
                10,
                11,
                12
              ],
              'name': 'Habitat 1',
              'index': 0,
            },
            {
              'items': [
                0,
                1,
                2,
                3,
                4,
                5,
                6,
                7,
                8,
                9,
                10,
                11,
                12
              ],
              'name': 'Habitat 2',
              'index': 1,
            },
            {
              'items': [
                0,
                1,
                2,
                3,
                4,
                5,
                6,
                7,
                8,
                9,
                10,
                11,
                12
              ],
              'name': 'Habitat 3',
              'index': 2,
            },
            {
              'items': [
                0,
                1,
                2,
                3,
                4,
                5,
                6,
                7,
                8,
                9,
                10,
                11,
                12
              ],
              'name': 'Habitat 4',
              'index': 3,
            }
          ]
        },
        buttonSelectors: {
          type: Array,
          notify: true,
          value: [
            {
              'highlightUrl': 'https://ltg.cs.uic.edu/WC/icons/species_00.svg',
              'activeUrl': 'https://ltg.cs.uic.edu/WC/icons/species_00_0.svg',
              'index': 0,
              'color': '#FFC91B',
              'type': 'h'
            },
            {
              'highlightUrl': 'https://ltg.cs.uic.edu/WC/icons/species_01.svg',
              'activeUrl': 'https://ltg.cs.uic.edu/WC/icons/species_01_0.svg',
              'index': 1,
              'color': '#5A6372',
              'type': 'p'
            },
            {
              'highlightUrl': 'https://ltg.cs.uic.edu/WC/icons/species_02.svg',
              'activeUrl': 'https://ltg.cs.uic.edu/WC/icons/species_02_0.svg',
              'index': 2,
              'color': '#FFDD00',
              'type': 'h'
            },
            {
              'highlightUrl': 'https://ltg.cs.uic.edu/WC/icons/species_03.svg',
              'activeUrl': 'https://ltg.cs.uic.edu/WC/icons/species_03_0.svg',
              'index': 3,
              'color': '#2C4721',
              'type': 'p'
            },
            {
              'highlightUrl': 'https://ltg.cs.uic.edu/WC/icons/species_04.svg',
              'activeUrl': 'https://ltg.cs.uic.edu/WC/icons/species_04_0.svg',
              'index': 4,
              'color': '#502B6E',
              'type': 'r'
            },
            {
              'highlightUrl': 'https://ltg.cs.uic.edu/WC/icons/species_05.svg',
              'activeUrl': 'https://ltg.cs.uic.edu/WC/icons/species_05_0.svg',
              'index': 5,
              'color': '#99cc33',
              'type': 'r'
            },
            {
              'highlightUrl': 'https://ltg.cs.uic.edu/WC/icons/species_06.svg',
              'activeUrl': 'https://ltg.cs.uic.edu/WC/icons/species_06_0.svg',
              'index': 6,
              'color': '#8975B5',
              'type': 'h'
            },
            {
              'highlightUrl': 'https://ltg.cs.uic.edu/WC/icons/species_07.svg',
              'activeUrl': 'https://ltg.cs.uic.edu/WC/icons/species_07_0.svg',
              'index': 7,
              'color': '#FAAA19',
              'type': 'h'
            },
            {
              'highlightUrl': 'https://ltg.cs.uic.edu/WC/icons/species_08.svg',
              'activeUrl': 'https://ltg.cs.uic.edu/WC/icons/species_08_0.svg',
              'index': 8,
              'color': '#899C7C',
              'type': 'p'
            },
            {
              'highlightUrl': 'https://ltg.cs.uic.edu/WC/icons/species_09.svg',
              'activeUrl': 'https://ltg.cs.uic.edu/WC/icons/species_09_0.svg',
              'index': 9,
              'color': '#4AB6C8',
              'type': 'r'
            },
            {
              'highlightUrl': 'https://ltg.cs.uic.edu/WC/icons/species_10.svg',
              'activeUrl': 'https://ltg.cs.uic.edu/WC/icons/species_10_0.svg',
              'index': 10,
              'color': '#68734F',
              'type': 'r'
            },
            {
              'highlightUrl': 'https://ltg.cs.uic.edu/WC/icons/env_temp.svg',
              'activeUrl': 'https://ltg.cs.uic.edu/WC/icons/env_temp_0.svg',
              'index': 11,
              'color': '#FF5722',
              'type': 'e'
            },
            {
              'highlightUrl': 'https://ltg.cs.uic.edu/WC/icons/env_pipe.svg',
              'activeUrl': 'https://ltg.cs.uic.edu/WC/icons/env_pipe_0.svg',
              'index': 12,
              'color': '#795548',
              'type': 'e'
            }
          ]
        },
        graphs: {
          type: Array,
          notify: true,
          value: []
        },
        envEventHistories: {
          type: Array,
          notify: true,
          value: []
        },
        chartOptions: {
          type: Object,
          notify: true,
          value: {
            legend: {position: 'none'},
            tooltip: {
              trigger: 'none'
            },
            viewWindow: {},
            enableInteractivity: false,
            animation: {
              startup: true,
              duration: 1000,
              //  easing: 'inAndOut'
              easing: 'out'
            },
            chartArea: {left: '5%', width: '93%', height: '75%'},
            vAxis: {
              minValue: 0,
              maxValue: 100,
              textStyle: {
                fontSize: 14
              }
            },
            hAxis: {
              textPosition: 'out',
              textStyle: {
                fontSize: 14
              },
              gridlines: {
                count: -1,
                units: {
                  days: {format: ['M/d']},
                  hours: {format: ['h a']},
                }
              },
              minorGridlines: {
                units: {
                  hours: {format: ['h:m a']},
                  minutes: {format: ['h:m a']}
                }
              }
            }
          }
        },
        maxes: {
          type: Object,
          value: {}
        },
        startDate: {
          type: Date,
          observer: 'startDateChanged'
        },
        endDate: {
          type: Date,
          observer: 'endDateChanged'
        },
        pickerDateFormat: {
          type: String,
          notify: false,
          value: 'MM-DD-YYYY'
        },
        alertMessage: {
          type: String,
          notify: true,
          value: ''
        },
        connected: {
          type: Boolean,
          notify: true,
          value: false,
          observer: 'connectedChanged'
        },
        debug: {
          type: Boolean,
          value: false
        }
      },
      observers: [
        'selectedItemsChanged(selectedItems.*)',
        'toggleSelectorsChanged(toggleSelectors.*)',
        'buttonSelectorsChanged(buttonSelectors.*)',
        'graphsChanged(graphs.*)'
      ],
      graphsChanged: function (changeRecord) {
        if (this.debug) {
          console.log('graphsChanged', changeRecord);
        }
      },
      selectedItemsChanged: function (changeRecord) {
        if (this.debug) {
          console.log('selectedItemsChanged', changeRecord);
        }
        if (changeRecord.path === 'selectedItems.splices') {

          var is = changeRecord.base.splices.indexSplices[0];

          if (is.addedCount > 0) {
            var l = changeRecord.base.length;
            var species = changeRecord.base[l - 1];
            if (species.index > 10) {
              this.updateGraph(species, 'environment_history');
            } else {
              this.updateGraph(species, 'population_history');
            }
            //this.updateEventHistoryPoints();
          } else if (is.removed[0] !== undefined) {
            var s = is.removed[0];
            for (var i = 0; i < this.graphs.length; i++) {
              var g = this.graphs[i];
              if (g.index === s.index) {
                this.splice('graphs', i, 1);
              }
            }

            for (var j = 0; j < this.graphs.length; j++) {
              var previousGraph = this.graphs[j];
              if (j === this.graphs.length - 1) {
                this.updateGraphAxis(previousGraph, 'on');
              } else {
                this.updateGraphAxis(previousGraph, 'off');
              }
              this.redrawChart(previousGraph);

            }


          }
          // a user was added or removed
        } else {
          // an individual user or its sub-properties changed
          // check "changeRecord.path" to determine what changed
        }
      },
      toggleSelectorsChanged: function (changeRecord) {
        if (this.debug) {
          console.log('toggleSelectorsChanged', changeRecord);
        }
      },
      buttonSelectorsChanged: function (changeRecord) {
        if (this.debug) {
          console.log('buttonSelectorsChanged', changeRecord);
        }
      },
      currentToggleChanged: function (newValue, oldValue) {
        if (this.debug) {
          console.log('newValue oldValue', JSON.stringify(newValue), JSON.stringify(oldValue));
        }
        this.set('selectedItems', []);
        this.clearAllGraphs();
      },
      showStartDateDialogAction: function () {
        this.$.startDateDialog.toggle();
      },
      showEndDateDialogAction: function () {
        this.$.endDateDialog.toggle();
      },
      dismissDialog: function (e) {
        if (e.detail.confirmed) {
          if (e.target.id === 'startDateDialog') {
            if (this.checkDatesValid()) {
              this.startDate = this.$.startDatePicker.date;
              this.updateAllGraphs();
            } else {
              this.showStartDateDialogAction();
            }
          } else if (e.target.id === 'endDateDialog') {
            if (this.checkDatesValid()) {
              this.endDate = this.$.endDatePicker.date;
              this.updateAllGraphs();
            } else {
              this.showEndDateDialogAction();
            }
          }
        }
      },
      checkDatesValid: function () {

        if (moment(this.startDate).isSame(this.endDate)) {
          return true;
        } else if (moment(this.startDate).isAfter(this.endDate)) {
          return false;
        } else if (moment(this.endDate).isBefore(this.startDate)) {
          return false;
        } else if (moment(this.endDate).isAfter(new Date())) {
          return false;
        } else {
          return true;
        }
      },
      startDateChanged: function (newValue, oldValue) {
        if (this.debug) {
          console.log('startDateChanged', newValue, oldValue);
        }
      },
      endDateChanged: function (newValue, oldValue) {
        if (this.debug) {
          console.log('endDateChanged', newValue, oldValue);
        }
      },
      clearAllGraphs: function () {
        this.set('graphs', []);
        this.set('envEventHistories', []);
      },
      updateEventHistoryPoints: function () {
        var sdate = moment(this.startDate).startOf('day').valueOf();
        var edate = moment(this.endDate).endOf('day').valueOf();
        var habitatIndex = this.currentToggle.index;
        var message = {habitat: habitatIndex, from: sdate, to: edate};

        this.addEventHistoryPoints(habitatIndex, sdate, edate, message);
      },
      updateGraph: function (species, type) {
        var sdate = moment(this.startDate).startOf('day').valueOf();
        var edate = moment(this.endDate).endOf('day').valueOf();
        var habitatIndex = this.currentToggle.index;

        var message;

        //environmental_variable: 0, 0=temperature 1=pipe length 2=brick area

        if (type === 'environment_history') {
          if (species.index === 11) {
            species.index = 0;
          } else if (species.index === 12) {
            species.index = 1;
          }

          message = {
            habitat: habitatIndex,
            environmental_variable: species.index,
            points: 100,
            from: sdate,
            to: edate
          };
        } else if (type === 'population_history') {
          message = {habitat: habitatIndex, species: species.index, points: 100, from: sdate, to: edate};
        }


        this.addHistoryGraph(species, habitatIndex, sdate, edate, message, type);
      },
      updateAllGraphs: function () {
        for (var i = 0; i < this.selectedItems.length; i++) {
          var species = this.selectedItems[i];
          if (species.index >= 11) {
            this.updateGraph(species, 'environment_history');
          } else {
            this.updateGraph(species, 'population_history');
          }

        }
      },
      addEventHistoryPoints: function (habitatIndex, sdate, edate, message) {
        var me = this;
        var sDateLocal = sdate;
        var eDateLocal = edate;
        console.log('MESSAGE FOR ENV EVENTS: ' + JSON.stringify(message));
        this.$.nutellaConn.nutella.net.request('environmental_events_history', message, function (response) {
          var r = response;
          console.log('EVENTS Response: ', r);

          if (r.length > 0) {


          } else {
            //zero results
            var firstEnvPoint = 'Date(' + moment(sDateLocal).subtract(1, 'minute').valueOf() + ')';
            //add one minute to the start time and set it 0
            t.push([firstDate, 0, species.color]);

            var lastEnvPoint = 'Date(' + moment(eDateLocal).add(2, 'minute').valueOf() + ')';
            //add one minute to the start time and set it 0
            t.push([lastDate2, 0, species.color]);

            //me.drawGraph(species, t, messageType, sdate, edate);

          }
        });


      },
      addHistoryGraph: function (species, habitatIndex, sdate, edate, message, type) {
        var me = this;
        var messageType = type;
        var sDateLocal = sdate;
        var eDateLocal = edate;
        var sSpecies = species;
        console.log(JSON.stringify(message));
        this.$.nutellaConn.nutella.net.request(type, message, function (response) {
          var r = response;
          console.log('response: ', r);
          var t = [

            [{label: 'Days', type: 'date'}, {label: 'Counts', type: 'number'}, {type: 'string', role: 'style'}]


          ];


          if (r.length > 0) {
            //environmental_variable: 0, 0=temperature 1=pipe length 2=brick area
            if (messageType === 'environment_history') {
              if (sSpecies.index === 0) {
                sSpecies.index = 11;
              } else if (sSpecies.index === 1) {
                sSpecies.index = 12;
              }


              for (var i1 = 0; i1 < r.length; i1++) {
                var d1 = 'Date(' + moment(r[i1].timestamp).valueOf() + ')';



                me.caluclateGraphMax(sSpecies, r[i1].value);

                t.push([d1, r[i1].value, sSpecies.color]);
              }
              me.drawGraph(sSpecies, t, 'environment_history', sdate, edate);

            } else if (messageType === 'population_history') {
              for (var i2 = 0; i2 < r.length; i2++) {
                var d2 = 'Date(' + moment(r[i2].timestamp).valueOf() + ')';

                me.caluclateGraphMax(sSpecies, r[i2].population);


                t.push([d2, r[i2].population, sSpecies.color]);
              }


              me.drawGraph(sSpecies, t, 'population_history', sdate, edate);
            }


          } else {
            //zero results
            var popFirstDate = 'Date(' + moment(sDateLocal).add(30, 'minute').valueOf() + ')';
            //add one minute to the start time and set it 0
            t.push([popFirstDate, 0, sSpecies.color]);

            var popLastDate = 'Date(' + moment(eDateLocal).subtract(30, 'minute').valueOf() + ')';
            //add one minute to the start time and set it 0
            t.push([popLastDate, 0, sSpecies.color]);

            me.drawGraph(sSpecies, t, messageType, sdate, edate);

          }


        });


      },

      drawGraph: function (species, data, type, to, from) {
        var foundGraphs = this.graphs.filter(function (el) {
          return (el.index === species.index);
        });

        var min = new Date(moment(from).subtract(1, 'minute').valueOf());
        var max = new Date(moment(to).add(1, 'minute').valueOf());
        //previous
        if (foundGraphs.length > 0) {


          var oldGraph = foundGraphs[0];
          oldGraph.data = data;
          oldGraph.options = this.chartOptions;
          oldGraph.options.hAxis.minValue = min;
          oldGraph.options.hAxis.maxValue = max;
          oldGraph.options.vAxis.minValue = 0;
          var b = this.getGraphMax(oldGraph);
          oldGraph.options.vAxis.maxValue = b;



          var index = this.graphs.indexOf(oldGraph);

          if (index !== this.graphs.length - 1) {
            this.updateGraphAxis(oldGraph, 'off');
            this.redrawChart(oldGraph);
          } else {
            this.updateGraphAxis(oldGraph, 'on');
            this.redrawChart(oldGraph);
          }
          if (this.debug) {
            console.log('updated graph');
          }

        } else {

          for (var j = 0; j < this.graphs.length; j++) {
            var previousGraph = this.graphs[j];
            this.updateGraphAxis(previousGraph, 'off');
            this.redrawChart(previousGraph);

          }

          //this.notifyPath('graphs.data', this.graphs);


          var g = {index: species.index, type: species.type, data: data, highlightUrl: species.highlightUrl};
          g.options = this.chartOptions;
          g.options.hAxis.minValue = min;
          g.options.hAxis.maxValue = max;
          g.options.vAxis.minValue = 0;
          var v = this.getGraphMax(g);
          g.options.vAxis.maxValue = v;

          this.updateGraphAxis(g, 'on');
          this.push('graphs', g);
          if (this.debug) {
            console.log('pushed graph');
          }
        }

      },
      getGraphMax: function(species) {
        if( species.type === 'r' ) {
          return this.maxes.r;
        } else if( species.type === 'h') {
          return this.maxes.h;
        } else if( species.type === 'p' ) {
          return this.maxes.p;
        } else if( species.type === 'e' ) {
          return this.maxes.e;
        }
      },
      caluclateGraphMax: function(critterType, value) {
        var max = 0;
        switch(critterType.type) {
          case 'r':
            if( value > this.maxes.r ) {
              this.maxes.r = value;
              max = this.maxes.r;
              return max;
            }
            break;
          case 'h':
            if( value > this.maxes.h) {
              this.maxes.h = value;
              max = this.maxes.h;
              return max;
            }
            break;
          case 'p':
            if( value > this.maxes.p) {
              this.maxes.p = value;
              max = this.maxes.p;
              return max;
            }
            break;
          case 'e':
            max = value;
            break;
        }
        return max;
      },
      updateGraphAxis: function (someGraph, type) {

        var v = this.getGraphMax(someGraph);
        someGraph.options.vAxis.maxValue = v;
        if (someGraph !== undefined) {
          switch (type) {
            case 'on':
              someGraph.options.hAxis.gridlines.units.hours = {format: ['h a']};
              someGraph.options.hAxis.gridlines.units.days = {format: ['M/d']};
              someGraph.options.hAxis.textPosition = 'out';
              break;
            case 'off':
              someGraph.options.hAxis.gridlines.units.hours = {format: [' ']};
              someGraph.options.hAxis.gridlines.units.days = {format: [' ']};
              someGraph.options.hAxis.textPosition = 'none';
              break;
            default:
              console.log('no switch type');
          }
        }

      },
      redrawChart: function (graph) {
        var chartId = this.chartName(graph.index);
        var chart = document.getElementById(chartId);
        chart.options = graph.options;
        chart.data = graph.data;
        chart.drawChart();
      },
      connectedChanged: function (newValue, oldValue) {
//        var me = this;
////                console.log('connected changed', newValue, oldValue);
//        if (newValue === true) {
//          this.$.nutellaConn.nutella.net.request('master_configuration', {}, function (r) {
//            if (r !== undefined) {
//              me.buttonSelectors = r.habitatItems;
//
//              var start = [{
//                'items': [],
//                'name': 'Habitat ?  ',
//                'index': -1
//              }];
//              me.toggleSelectors = start.concat(r.habitats);
////                            console.log('MASTER CONFIG FETCHED');
//
//            }
//
//          });
//        }
      },
      ready: function () {
        this.startDate = new Date();
        this.endDate = this.startDate;
        this.selectedItems = [];
        this.graphs = [];
        this.envEventHistories = [];

        var start = [{
          'items': [],
          'name': 'Habitat ?  ',
          'index': -1
        }];
        this.toggleSelectors = start.concat(this.toggleSelectors);

        this.maxes = { r: 0.1, h: 0.1, p: 0.1, e: 0.1 };

      },
      chartName: function (index) {
        console.log('graph ' + index);
        return 'chart' + index;
      },
      formatButtonSDate: function (someDate) {
        var formatted = moment(someDate).format('MM/DD/YY');
        return formatted;
      },
      formatButtonEDate: function (someDate) {
        var formatted = moment(someDate).format('MM/DD/YY');
        return formatted;
      },
    });
  </script>
</dom-module>
